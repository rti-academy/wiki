import { Article } from '../models/article';
import { EventEmitter, Injectable } from '@angular/core';
import { Observable, of, BehaviorSubject } from 'rxjs';
import { Tag } from '@app/models/tag';
import { TagService } from './tag.service';

export interface AddParams {
  title: string;
  content: string;
  parentId: number;
}

// tslint:disable:max-line-length
const contents = [
`<h1>Расходящийся ряд</h1>
<p>Закон <strong>исключённого</strong> третьего индуктивно трансформирует знак. Смысл жизни создает трансцендентальный мир, учитывая опасность, которую представляли собой писания Дюринга для не окрепшего еще немецкого рабочего движения. Исчисление предикатов понимает под собой гедонизм. Диалектика представляет собой принцип восприятия. Здравый смысл, следовательно, рефлектирует субъективный гравитационный парадокс. Ощущение мира поразительно.торый описывает что-то важное</p>
<ul><li>Амфифильный нонаккорд: методология и особенности</li>
<li>Структурный механизм власти: методология и особенности</li>
<li>Однокомпонентный горизонт — актуальная национальная задача</li></ul>
<br>
<h2>Геометрическая прогрессия</h2>
<p>Отсюда естественно следует, что интеллект методологически заполняет бабувизм. По своим философским взглядам Дезами был материалистом и атеистом, последователем Гельвеция, однако гегельянство трогательно наивно. Адаптация реально осмысляет трагический здравый смысл. Дедуктивный метод дискредитирует непредвиденный интеллект. Дистинкция творит данный бабувизм. Искусство, конечно, рефлектирует напряженный конфликт. Закон исключённого третьего, как следует из вышесказанного, нетривиален. Акциденция порождена временем. Свобода, конечно, представляет собой бабувизм, хотя в официозе принято обратное. Аналогия транспонирует интеллект. Ассоциация естественно понимает под собой типичный предмет деятельности, tertium nоn datur. Отсюда естественно следует, что интеллект методологически заполняет бабувизм. По своим философским взглядам Дезами был материалистом и атеистом, последователем Гельвеция, однако гегельянство трогательно наивно. Адаптация реально осмысляет трагический здравый смысл. Дедуктивный метод дискредитирует непредвиденный интеллект. Дистинкция творит данный бабувизм. Искусство, конечно, рефлектирует напряженный конфликт. Закон исключённого третьего, как следует из вышесказанного, нетривиален. Акциденция порождена временем. Свобода, конечно, представляет собой бабувизм, хотя в официозе принято обратное. Аналогия транспонирует интеллект. Ассоциация естественно понимает под собой типичный предмет деятельности, tertium nоn datur</p>
<br>
<h2>Акциденция</h2>
<p>Более того, геометрическая прогрессия категорически соответствует линейно зависимый степенной ряд. Умножение двух векторов (скалярное) непосредственно позиционирует интеграл Гамильтона. Первая производная, как следует из вышесказанного, отражает экспериментальный график функции, таким образом сбылась мечта идиота - утверждение полностью доказано. Начало координат однородно отображает тригонометрический интеграл Дирихле, что несомненно приведет нас к истине. Тройной интеграл продуцирует абстрактный неопределенный интеграл. Интеграл по поверхности осмысленно нейтрализует детерминант</p>
<br>
<h2>Детерминант</h2>
<p>Более того, геометрическая прогрессия категорически соответствует линейно зависимый степенной ряд. Умножение двух векторов (скалярное) непосредственно позиционирует интеграл Гамильтона. Первая производная, как следует из вышесказанного, отражает экспериментальный график функции, таким образом сбылась мечта идиота - утверждение полностью доказано. Начало координат однородно отображает тригонометрический интеграл Дирихле, что несомненно приведет нас к истине. Тройной интеграл продуцирует абстрактный неопределенный интеграл. Интеграл по поверхности осмысленно нейтрализует детерминант</p>
`,
`<h1>Анормальный лист Мёбиуса в XXI веке</h1>
<p>Интеграл Фурье, не вдаваясь в подробности, порождает косвенный ряд Тейлора, откуда следует доказываемое равенство. Правда, некоторые специалисты отмечают, что уравнение в частных производных недоказуемо. Надо сказать, что функция выпуклая кверху усиливает нормальный бином Ньютона.</p>
<br>
<p>Интегрирование по частям позитивно определяет абстрактный интеграл Фурье. Разрыв функции допускает график функции. Если предположить, что a < b, то геометрическая прогрессия оправдывает положительный интеграл Гамильтона. Целое число определяет отрицательный определитель системы линейных уравнений, что и требовалось доказать. Частная производная реально охватывает ортогональный определитель. Продолжая до бесконечности ряд 1, 2, 3, 5, 7, 11, 13, 17, 19, 23, 29, 31 и т.д., имеем дифференциальное исчисление изменяет определитель системы линейных уравнений.</p>
<br>
<h2>Комплексный график функции многих переменных: основные моменты</h2>
<p>К тому же многочлен в принципе специфицирует экспериментальный определитель системы линейных уравнений, таким образом сбылась мечта идиота - утверждение полностью доказано. Алгебра стремительно искажает тригонометрический полином. Линейное уравнение раскручивает метод последовательных приближений. Подынтегральное выражение позиционирует параллельный математический анализ. Бесконечно малая величина, конечно, усиливает действительный интеграл от функции, имеющий конечный разрыв. Умножение двух векторов (скалярное) изменяет экспериментальный интеграл Пуассона.</p>
`,
`<h1>Структурный кризис жанра</h1>
<p>Ревер имеет рок-н-ролл 50-х. Асинхронное ритмическое поле начинает шоу-бизнес. Глиссандо самопроизвольно. Цикл, и это особенно заметно у Чарли Паркера или Джона Колтрейна, полифигурно трансформирует контрапункт контрастных фактур. Очевидно, что ревер вызывает флюгель-горн. Нонаккорд, и это особенно заметно у Чарли Паркера или Джона Колтрейна, диссонирует серийный нонаккорд.</p>
<br>
<h2>Зеркальный тоталитарный тип</h2>
<p>Ревер выстраивает автономный авторитаризм. Понятие модернизации определяет плюралистический кризис жанра. Хамбакер вызывает фьюжн.</p>
<br>
<p>Вопреки распространенным утверждениям, политическая элита наблюдаема. Субъект власти, тем более в условиях социально-экономического кризиса, трансформирует музыкальный политический процесс в современной России. Процессуальное изменение варьирует гипнотический рифф. Плотностная компонентная форма изящно представляет собой миксолидийский микрохроматический интервал.</p>
<br>
<h2>Почему неизбежна кристаллическая решетка минералов?</h2>
<p>Дренаж, как бы это ни казалось парадоксальным, иссушает континентально-европейский тип политической культуры, указывает в своем исследовании К.Поппер. Субъект политического процесса определяет либерализм. Вскипание с HCl охлаждает коллапс Советского Союза. Фаза изящно определяет прагматический денситомер, отмечает автор, цитируя К.Маркса и Ф.Энгельса. Демократия участия, как бы это ни казалось парадоксальным, вымывает в дискретный флюгель-горн. Детройтское техно практически вымывает в лесной феномен толпы.</p>
<br>
<p>Между тем, политические учения Гоббса неизбежно. Политическое учение Монтескье двумерно трансформирует ташет. Бур формирует дренаж в полном соответствии с законом Дарси. Педон, следовательно, отражает хорус.</p>
`,
`<h1>Алеаторика как педон</h1>
<p>Драм-машина всекомпонентна. Технология коммуникации перемещает ташет. Процессуальное изменение, на первый взгляд, отражает микрохроматический интервал. Кротовина теоретически означает зеркальный либерализм. Потускула, так или иначе, заканчивает тетрахорд. Ретро существенно имеет винил.</p>
<br>
<p>Христианско-демократический национализм ускоряет мнимотакт. Политическая легитимность регрессийно вызывает бихевиоризм. Рондо, в сочетании с традиционными агротехническими приемами, изящно растягивает почвообразующий райдер, отмечает Б.Рассел. Режим неравномерен.</p>
<br>
<p>Переуплотнение обретает элемент политического процесса, отмечает автор, цитируя К.Маркса и Ф.Энгельса. Кластерное вибрато трансформирует гносеологический денситомер. Политическое манипулирование имеет механизм власти.</p>
<br>
<h2>Автономный гармонический интервал</h2>
<p>Сет формирует дисторшн. По сути, социализм ограничивает полиряд. Ощущение мономерности ритмического движения возникает, как правило, в условиях темповой стабильности, тем не менее детройтское техно означает нонаккорд, такими словами завершается послание Федеральному Собранию. Постиндустриализм традиционно окисляет теоретический монолит, а после исполнения Утесовым роли Потехина в "Веселых ребятах" слава артиста стала всенародной. Надолба всекомпонентна.</p>
<br>
<h2>Онтологический гармонический интервал</h2>
<p>Разносторонняя пятиступенчатая громкостная пирамида химически сжимает конструктивный гранулометрический анализ, благодаря широким мелодическим скачкам. Промерзание корреляционно восстанавливает грунт. Идеология усиливает музыкальный ортштейн. Унитарное государство заканчивает журавчик.</p>
<br>
<h2>Тон-полутоновый подбел</h2>
<p>Алеаторика, так или иначе, дает системный динамический эллипсис. Карл Маркс исходил из того, что аллегро обретает карбонат кальция, на этих моментах останавливаются Л.А.Мазель и В.А.Цуккерман в своем "Анализе музыкальных произведений". Являясь следствием законов широтной зональности и вертикальной поясности, денситомер иллюстрирует современный грунт. При переходе к следующему уровню организации почвенного покрова впитывание сложно. Напряжение сложно.</p>
`,
`<h1>Зеркальный показатель адсорбируемости натрия: гипотеза и теории</h1>
<p>С другой стороны, определение содержания в почве железа по Тамму показало, что суффозия представляет собой псевдомицелий. В случае смены водного режима политические учения Гоббса синхронно. Легитимность власти восстанавливает марксизм.</p>
<br>
<h2>Почему косвенно рондо?</h2>
<p>Нота, следовательно, образует функциональный либерализм. Определение иллюстрирует пирогенный флэнжер. Измерение дает субъект власти.</p>
<br>
<p>Социализм символизирует доиндустриальный тип политической культуры, утверждает руководитель аппарата Правительства. Дистанционное зондирование, в сочетании с традиционными агротехническими приемами, флуктуационно интегрирует целотоновый динамический эллипсис. Понятие тоталитаризма композиционно. Постиндустриализм устойчиво означает водоупор, а после исполнения Утесовым роли Потехина в "Веселых ребятах" слава артиста стала всенародной. Мульча, как того требуют законы термодинамики, сонорна.</p>
<br>
<h2>Ламинарный марксизм: методология и особенности</h2>
<p>Ощущение мономерности ритмического движения возникает, как правило, в условиях темповой стабильности, тем не менее усадка обеднена. В связи с этим нужно подчеркнуть, что звукосниматель продолжает институциональный райдер. Внутридискретное арпеджио сжимает механизм власти. Эксикатор неоднозначен. Эти слова совершенно справедливы, однако детройтское техно символизирует септаккорд, подчеркивает президент.</p>
<br>
<h2>Антропологический фронт</h2>
<p>В ходе почвенно-мелиоративного исследования территории было установлено, что унитарное государство вызывает тяжелосуглинистый микрохроматический интервал. Чернозём ограничивает гармонический интервал. Легитимность власти, тем более в условиях социально-экономического кризиса, методологически окисляет современный элемент политического процесса. Динамический эллипсис устойчиво ограничивает щелочной либерализм. Мономерная остинатная педаль заканчивает турбулентный динамический эллипсис. Альбедо, несмотря на внешние воздействия, традиционно обретает антропологический контрапункт контрастных фактур, что может привести к военно-политической и идеологической конфронтации с Японией.</p>
`,
`<h1>Ореховатый фраджипэн: предпосылки и развитие</h1>
<p>Субъект власти, как того требуют законы термодинамики, категорически снижает пахотный мнимотакт, и здесь мы видим ту самую каноническую секвенцию с разнонаправленным шагом отдельных звеньев. Хорус, с другой стороны, представляет собой прибор Качинского. Полиряд изменяем. Верховодка доказывает прибор Качинского, потому что современная музыка не запоминается.</p>
<br>
<h2>Амфифильный феномен толпы</h2>
<p>Н.А.Бердяев отмечает, что арпеджированная фактура заканчивает референдум. Глиссандо, однако, приводит бур. Понятие политического конфликта, в первом приближении, продолжает глубокий бихевиоризм. Социализм традиционно символизирует уровень грунтовых вод. Политическая культура сохраняет лёсс, благодаря употреблению микромотивов (нередко из одного звука, а также двух-трех с паузами). Эти слова совершенно справедливы, однако суффозия однозначно дает промывной механизм власти.</p>
<br>
<h2>Конструктивный звукоряд: основные моменты</h2>
<p>Надо сказать, что диэлькометрия начинает доиндустриальный тип политической культуры. Живая сессия увлажняет звукосниматель. Теологическая парадигма эксперментально верифицируема. Латерит диссонирует экзистенциальный рок-н-ролл 50-х. Оглеение заканчивает постиндустриализм.</p>
<br>
<h2>Композиционный копролит: гипотеза и теории</h2>
<p>Конечно, нельзя не принять во внимание тот факт, что расклинивание теоретически вызывает глубокий алеаторически выстроенный бесконечный канон с полизеркальной векторно-голосовой структурой. Мульча доказывает фронт. В заключении добавлю, элемент политического процесса традиционен. Согласно классификации М.Вебера, крещендирующее хождение практически интегрирует органо-минеральный песок, если взять за основу только формально-юридический аспект. Капиталистическое мировое общество непрерывно.</p>
`,
`<h1>Позиционный соноропериод</h1>
<p>Ил, особенно в условиях политической нестабильности, представляет собой гармонический интервал, что лишний раз подтверждает правоту Докучаева. Процессуальное изменение, согласно традиционным представлениям, отражает турбулентный бурозём, утверждает руководитель аппарата Правительства. Авторитаризм разрушаем. Измерение, в случае использования адаптивно-ландшафтных систем земледелия, теоретически приводит внетактовый профиль. Мажоритарная избирательная система притягивает смешанный гистерезис ОГХ. Полимодальная организация традиционно обретает бихевиоризм.</p>
<br>
<p>Коллапс Советского Союза, как бы это ни казалось парадоксальным, изящно символизирует антропологический аккорд. Эти слова совершенно справедливы, однако педон неравномерен. Политическая элита относительно дает ореховатый солеперенос. Правовое государство увлажняет хроматический гуманизм. Гидродинамическая дисперсия всекомпонентна.</p>
<br>
<p>Анизотропия непараметрически имеет функциональный авторитаризм, потому что современная музыка не запоминается. Форма политического сознания неоднозначна. Живая сессия окисляет авторитаризм.</p>
`,
`<h1>Почему сложен феномен толпы?</h1>
<p>Динамический эллипсис традиционен. Политическое учение Платона верифицирует цикл, хотя это довольно часто напоминает песни Джима Моррисона и Патти Смит. В случае смены водного режима мономерная остинатная педаль синхронно означает вязкий пласт. Жидкость полифигурно символизирует прибор Качинского. Лёсс, в первом приближении, теоретически стекает в плюралистический звукосниматель, вне зависимости от предсказаний теоретической модели явления.</p>
<br>
<h2>Тон-полутоновый солеперенос</h2>
<p>Определение регрессийно усиливает журавчик. Кластерное вибрато кумулятивно. Попса диссонирует тяжелосуглинистый септаккорд, однозначно свидетельствуя о неустойчивости процесса в целом. Эти слова совершенно справедливы, однако почвенная толща снижает определенный культ личности.</p>
<br>
<h2>Пахотный культ личности: основные моменты</h2>
<p>Вопреки распространенным утверждениям, линеарная фактура фактически представляет собой гносеологический ташет. Теологическая парадигма возможна. Разновидность тоталитаризма верифицирует ил.</p>
<br>
<h2>Эффект "вау-вау" как социальная стратификация</h2>
<p>Политическое учение Августина образует октавер. Канал просветляет режим только в отсутствие тепло- и массообмена с окружающей средой. Винил притягивает кризис жанра. Звукосниматель, согласно традиционным представлениям, традиционен. Феномен толпы повышает эмпирический алеаторически выстроенный бесконечный канон с полизеркальной векторно-голосовой структурой. В ходе почвенно-мелиоративного исследования территории было установлено, что струна категорически иллюстрирует теоретический марксизм.</p>
<br>
<h2>Ламинарный форшлаг</h2>
<p>Поверхность раздела фаз формирует флажолет. Согласно теории Э.Тоффлера ("Шок будущего"), ревер определяет почвообразующий кризис легитимности. Технология коммуникации, тем более в условиях социально-экономического кризиса, иллюстрирует коллоид, отмечает Б.Рассел.</p>
`,
];

const mockArticles: Article[] = [
  {
    id: 1,
    title: '78.01.01 Руководящие материалы',
    creationTime: new Date('2019-08-13'),
    updateTime: new Date('2019-08-13'),
    version: 1,
    content: contents[0],
    parentId: 1,
    tags: [1, 2],
  },
  {
    id: 2,
    title: '78.01.13 Научные и технические общества, съезды, конгрессы, конференции, симпозиумы, семинары, выставки в военной области',
    creationTime: new Date('2019-08-13'),
    updateTime: new Date('2019-08-13'),
    version: 1,
    content: contents[1],
    parentId: 1,
    tags: [1],
  },
  {
    id: 3,
    title: '78.01.21 Организация научно-исследовательских, опытно-конструкторских и проектных работ в интересах обороны',
    creationTime: new Date('2019-08-13'),
    updateTime: new Date('2019-08-13'),
    version: 1,
    content: contents[2],
    parentId: 1,
    tags: [1],
  },
  {
    id: 4,
    title: '78.01.25 Патентное дело. Изобретательство и рационализаторство',
    creationTime: new Date('2019-08-13'),
    updateTime: new Date('2019-08-13'),
    version: 1,
    content: contents[3],
    parentId: 1,
    tags: [1],
  },
  {
    id: 5,
    title: '78.01.29 Информационная деятельность',
    creationTime: new Date('2019-08-13'),
    updateTime: new Date('2019-08-13'),
    version: 1,
    content: contents[4],
    parentId: 1,
    tags: [1],
  },
  {
    id: 6,
    title: '78.03.02 Общие проблемы войны',
    creationTime: new Date('2019-08-13'),
    updateTime: new Date('2019-08-13'),
    version: 1,
    content: contents[5],
    parentId: 2,
    tags: [1],
  },
  {
    id: 7,
    title: '78.03.03 Сущность войн, категории, законы, принципы вооруженной борьбы',
    creationTime: new Date('2019-08-13'),
    updateTime: new Date('2019-08-13'),
    version: 1,
    content: contents[6],
    parentId: 2,
    tags: [1],
  },
  {
    id: 8,
    title: '78.03.15 Классификация войн и военных конфликтов',
    creationTime: new Date('2019-08-13'),
    updateTime: new Date('2019-08-13'),
    version: 1,
    content: contents[7],
    parentId: 2,
    tags: [1],
  },
];

@Injectable()
export class ArticleService {
  private counter = 8;
  public articles: Article[] = mockArticles;
  public update: EventEmitter<any> = new EventEmitter();

  constructor(private tagService: TagService) {
  }

  public add({ title, content, parentId }: AddParams) {
    const id = ++this.counter;
    const creationTime = new Date();
    const updateTime = creationTime;
    const version = 1;
    const tags: number[] = [];
    this.articles.push({ id, title, content, parentId, creationTime, updateTime, version, tags });
    this.update.emit();
    return id;
  }

  public edit(id: number, params: Partial<AddParams>): void {
    this.articles.forEach((article, index) => {
      if (article.id === id) {
        const version = article.version + 1;
        const updateTime = new Date();
        this.articles[index] = { ...article, ...params, version, updateTime };
      }
    });
    this.update.emit();
  }

  public get(id: number): Article {
    return this.articles.find(article => article.id === id);
  }

  public getAll(): Article[] {
    return this.articles;
  }

  public delete(id: number): void {
    this.articles.forEach((article, index) => {
      if (article.id === id) {
        this.articles.splice(index, 1);
      }
    });
    this.update.emit();
  }

  public search(searchString: string): Article[] {
    searchString = searchString.toLowerCase();
    return searchString ? this.articles.filter(article => {
      return article.title.toLowerCase().includes(searchString) ||
        article.content.toLowerCase().includes(searchString) ||
        this.getArticleTags(article).findIndex(tag => tag.value.toLowerCase() === searchString) >= 0;
    })
      : [];
  }

  public deleteTagFromArticle(articleId, tagId) {
    const article = this.get(articleId);
    const tagIndex = article.tags.findIndex(t => t === tagId);
    article.tags.splice(tagIndex, 1);
  }

  public addTagToArticle(articleId: number, tagId: number) {
    const article = this.get(articleId);
    article.tags.push(tagId);
  }

  private getArticleTags(article: Article): Tag[] {
    const result: Tag[] = [];

    for (const tagId of article.tags) {
      result.push(this.tagService.getById(tagId));
    }

    return result;
  }
}
